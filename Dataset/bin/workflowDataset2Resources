#!/usr/bin/perl

use strict;
use lib "$ENV{GUS_HOME}/lib/perl";
use XML::Twig;
use File::Basename;
use ReFlow::Dataset::Datasets;
use ReFlow::Dataset::Classes;
use ReFlow::Dataset::Template;
use Data::Dumper;
use File::Path;

usage() unless scalar(@ARGV) == 2;

my ($datasetFile, $classesFile) = @ARGV;

# parse class file
my $classes = ReFlow::Dataset::Classes->new($classesFile);

# parse datasets file
my $datasets = ReFlow::Dataset::Datasets->new($datasetFile);
my $classNamesUsed = $datasets->getClassNamesUsed();

# NEED TO VALIDATE DATASET AGAINST CLASSES
my $datasetsFullName = $datasets->getFullName();
my $resourcesFileName = "$ENV{GUS_HOME}/lib/xml/datasources/${datasetsFullName}.xml";
my ($basename,$path,$suffix) = fileparse($resourcesFileName, '.xml');
mkpath($path);
open(F, ">$resourcesFileName") || die "Can't open file file '$resourcesFileName' for writing\n";

print F "<resources>\n\n";
foreach my $dataset (@{$datasets->getDatasets()}) {
    my $resourceText = $classes->getResourceText($dataset);
    print F "$resourceText\n";
}
print F "</resources>\n\n";


sub usage {

  print "
Create a resource xml file for a dataset

Usage:  workflowDataset2Resources datasets_file classes_file

Where:
  datasets_file:    an xml file containing a set of datasets.  Must be in a file
                    path including lib/xml/datasets/XXX/YYY.xml where XXX is one
                    or more optional subirs, and YYY is the name of the dataset.
                    Files generated from plans will be named like this:
                    XXX/YYY/planFileName.xml

  classes_file:     an xml file containing a set of dataset classes.

Output: the generated resources xml file in \$GUS_HOME/lib/xml/datasources

";

  exit(1);
}
